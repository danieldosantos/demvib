<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>MedVibe</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1666c4;
      --primary-dark: #114f96;
      --surface: #ffffff;
      --surface-alt: #f4f7fb;
      --surface-soft: #eef3fb;
      --border: #d8e3f3;
      --bg: #e8eff8;
      --fg: #0f1c2e;
      --muted: #627089;
      --danger: #d6455d;
      --warning: #f4a62a;
      --success: #3aa76d;
      --accent: #0fb8ad;
      --shadow: 0 18px 42px -24px rgba(13, 56, 104, 0.45);
      --radius-lg: 18px;
      --radius-md: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(180deg, #f1f5fd 0%, #e8eff8 100%);
      color: var(--fg);
      line-height: 1.6;
    }

    a {
      color: var(--primary);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .app-shell {
      max-width: 1440px;
      margin: 0 auto;
      padding: 48px 32px 64px;
    }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      padding: 32px;
      background: rgba(255, 255, 255, 0.78);
      backdrop-filter: blur(12px);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: var(--shadow);
    }

    .page-title {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .page-title svg {
      width: 48px;
      height: 48px;
      color: var(--primary);
    }

    .page-title h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
    }

    .page-title p {
      margin: 6px 0 0;
      font-size: 15px;
      color: var(--muted);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(22, 102, 196, 0.12);
      color: var(--primary-dark);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .dashboard-grid {
      display: grid;
      gap: 28px;
      margin-top: 32px;
      grid-template-columns: minmax(0, 1fr);
      grid-template-areas:
        "prontuario"
        "exames"
        "listagem"
        "logs";
    }

    .dashboard-grid > .card {
      min-width: 0;
    }

    .card--prontuario { grid-area: prontuario; }
    .card--exames { grid-area: exames; }
    .card--listagem { grid-area: listagem; }
    .card--logs { grid-area: logs; }

    .card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 32px;
      border: 1px solid rgba(255, 255, 255, 0.7);
      box-shadow: 0 14px 34px -24px rgba(15, 28, 46, 0.55);
    }

    .card--logs {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .section-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
    }

    .section-header h2 {
      margin: 0;
      font-size: 22px;
      font-weight: 700;
    }

    .section-subtitle {
      margin-top: 6px;
      display: block;
      font-size: 13px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight: 600;
    }

    .section-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: flex-end;
    }

    .info-banner {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      padding: 16px 20px;
      border-radius: var(--radius-md);
      background: var(--surface-alt);
      border: 1px solid var(--border);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    .info-chip {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 160px;
    }

    .info-chip.compact {
      min-width: auto;
    }

    .info-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      font-weight: 600;
    }

    .info-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--fg);
    }

    .section-body {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
    }

    input, textarea, select {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 14px;
      color: var(--fg);
      box-shadow: inset 0 1px 2px rgba(15, 28, 46, 0.08);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(22, 102, 196, 0.15);
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
    }

    .actions {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .actions.actions--inline {
      justify-content: space-between;
      gap: 16px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 12px;
      border: 1px solid transparent;
      padding: 10px 18px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      background: var(--surface-alt);
      color: var(--fg);
      transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px -20px rgba(15, 28, 46, 0.65);
    }

    .btn:focus-visible {
      outline: none;
      box-shadow: 0 0 0 4px rgba(22, 102, 196, 0.25);
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: var(--surface-alt);
      border-color: var(--border);
      color: var(--primary-dark);
    }

    .btn-outline {
      background: transparent;
      border-color: var(--border);
      color: var(--primary-dark);
    }

    .btn-danger {
      background: rgba(214, 69, 93, 0.12);
      color: var(--danger);
      border-color: rgba(214, 69, 93, 0.45);
    }

    .btn-ghost {
      background: transparent;
      border-color: transparent;
      color: var(--muted);
    }

    .btn-link {
      background: transparent;
      border-color: transparent;
      color: var(--primary-dark);
      padding: 6px 0;
      font-weight: 600;
    }

    .btn-sm {
      padding: 8px 14px;
      font-size: 13px;
      border-radius: 10px;
    }

    .btn svg {
      width: 18px;
      height: 18px;
    }

    .btn-sm svg {
      width: 16px;
      height: 16px;
    }

    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
      transform: none;
      box-shadow: none;
    }

    .btn.is-loading {
      pointer-events: none;
    }

    .spinner {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.4);
      border-top-color: #fff;
      animation: spin 1s linear infinite;
    }

    .btn:not(.btn-primary) .spinner {
      border-color: rgba(22, 102, 196, 0.3);
      border-top-color: var(--primary);
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    .chipbox {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px;
      border-radius: var(--radius-md);
      background: var(--surface-alt);
      border: 1px dashed var(--border);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: #fff;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 13px;
      font-weight: 500;
    }

    .chip-remove {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--muted);
    }

    .chip-remove:hover {
      color: var(--danger);
    }

    .chipbox input {
      flex: 1 1 260px;
      min-width: 200px;
      border: none;
      background: transparent;
      padding: 4px 0;
      box-shadow: none;
    }

    .chipbox input:focus {
      border: none;
      box-shadow: none;
      outline: none;
    }

    .preview-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 18px;
      padding: 18px;
      background: var(--surface-alt);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }

    .preview-panel textarea {
      min-height: 120px;
      background: #fff;
    }

    .exam-card-grid {
      display: grid;
      gap: 18px;
    }

    .exam-card {
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: var(--surface-alt);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 18px;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }

    .exam-card h4 {
      margin: 0;
      font-size: 18px;
      color: var(--primary-dark);
    }

    .exam-card textarea {
      min-height: 100px;
    }

    .exam-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .exam-results-list {
      border: 1px dashed var(--border);
      border-radius: var(--radius-md);
      padding: 12px;
      background: #fff;
    }

    .exam-result-item {
      font-size: 13px;
      padding-bottom: 10px;
      margin-bottom: 10px;
      border-bottom: 1px solid rgba(15, 28, 46, 0.08);
    }

    .exam-result-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .exam-result-item pre {
      margin-top: 8px;
      background: #0d1117;
      color: #c9d1d9;
      border-radius: 10px;
      padding: 10px;
      white-space: pre-wrap;
    }

    .ia-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-start;
      padding: 16px;
      border-radius: var(--radius-md);
      background: var(--surface-alt);
      border: 1px solid var(--border);
    }

    .ia-panel p {
      margin: 0;
      flex: 1 1 200px;
      font-size: 13px;
      color: var(--muted);
    }

    .diagnostico-area {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      background: var(--surface-alt);
      border: 1px solid transparent;
      color: var(--muted);
    }

    .grav-baixa {
      background: rgba(58, 167, 109, 0.12);
      color: var(--success);
      border-color: rgba(58, 167, 109, 0.4);
    }

    .grav-moderada {
      background: rgba(244, 166, 42, 0.12);
      color: var(--warning);
      border-color: rgba(244, 166, 42, 0.45);
    }

    .grav-alta {
      background: rgba(214, 69, 93, 0.12);
      color: var(--danger);
      border-color: rgba(214, 69, 93, 0.45);
    }

    .data-surface {
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--surface-alt);
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead th {
      text-align: left;
      padding: 14px 18px;
      background: #fff;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
    }

    tbody td {
      padding: 16px 18px;
      border-top: 1px solid var(--border);
      vertical-align: top;
    }

    .record-id {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 8px;
      background: rgba(22, 102, 196, 0.1);
      color: var(--primary-dark);
      font-weight: 600;
      font-size: 13px;
    }

    .record-name {
      font-weight: 600;
      font-size: 16px;
    }

    .record-cpf {
      margin-top: 4px;
      font-size: 13px;
    }

    .record-date {
      font-weight: 600;
      font-size: 14px;
      color: var(--primary-dark);
    }

    .diagnostico-resumo {
      font-size: 13px;
      line-height: 1.5;
      background: #fff;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 12px;
      max-height: none;
      overflow: visible;
      white-space: pre-wrap;
    }

    .records-exams {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }

    .table-chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 184, 173, 0.12);
      color: var(--accent);
      font-size: 12px;
      font-weight: 600;
    }

    .empty-state {
      padding: 36px;
      text-align: center;
    }

    .log-surface {
      flex: 1;
      border-radius: var(--radius-md);
      border: 1px solid rgba(15, 22, 41, 0.6);
      background: #0f172a;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
      overflow: hidden;
    }

    pre {
      margin: 0;
      padding: 20px;
      color: #c9d1d9;
      font-size: 13px;
      line-height: 1.6;
      font-family: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
      white-space: pre-wrap;
    }

    #examesLista {
      display: inline-flex;
      align-items: center;
      font-size: 13px;
      color: var(--muted);
    }

    @media (min-width: 1200px) {
      .dashboard-grid {
        grid-template-columns: minmax(0, 1.5fr) minmax(0, 1fr);
        grid-template-areas:
          "prontuario listagem"
          "exames logs";
        align-items: start;
      }

      .card--listagem,
      .card--logs {
        align-self: start;
      }

      .exam-card-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }
    }

    @media (min-width: 1600px) {
      .dashboard-grid {
        grid-template-columns: minmax(0, 1.6fr) minmax(0, 0.9fr);
      }
    }

    @media (max-width: 880px) {
      .page-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .section-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .actions.actions--inline {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 600px) {
      .app-shell {
        padding: 32px 16px 48px;
      }

      .card {
        padding: 24px;
      }
    }
  </style>
</head>
<body>
  <main class="app-shell">
    <header class="page-header">
      <div class="page-title">
        <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <rect x="4" y="6" width="40" height="36" rx="10" ry="10" stroke="currentColor" stroke-width="3" fill="rgba(22, 102, 196, 0.08)" />
          <path d="M16 24h16" stroke="currentColor" stroke-width="3" stroke-linecap="round" />
          <path d="M24 16v16" stroke="currentColor" stroke-width="3" stroke-linecap="round" />
        </svg>
        <div>
          <h1>MedVibe Prontuário Clínico</h1>
          <p>Registro estruturado de anamnese, exames e diagnósticos assistidos por IA.</p>
        </div>
      </div>
      <span class="status-pill">Ambiente clínico seguro</span>
    </header>

    <div class="dashboard-grid">
      <section class="card card--prontuario">
        <div class="section-header">
          <div>
            <h2>Prontuário do Paciente</h2>
            <span class="section-subtitle">Dados essenciais do atendimento</span>
          </div>
        </div>
        <div class="section-body">
          <div class="info-banner">
            <div class="info-chip">
              <span class="info-label">Prontuário selecionado</span>
              <span class="info-value" id="sel-id">—</span>
            </div>
            <div class="info-chip">
              <span class="info-label">Paciente</span>
              <span class="info-value" id="sel-nome">Em preenchimento</span>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="nome">Nome</label>
              <input id="nome" placeholder="Ex.: Ana Souza" />
            </div>
            <div class="field">
              <label for="cpf">CPF</label>
              <input id="cpf" placeholder="000.000.000-00" />
            </div>
            <div class="field">
              <label for="data">Data da consulta</label>
              <input id="data" placeholder="YYYY-MM-DD" />
              <span class="hint">Formato recomendado: 2025-10-21</span>
            </div>
          </div>

          <div class="field">
            <label for="sintomas">Sintomas</label>
            <textarea id="sintomas" placeholder="Descreva sintomas, duração, intensidade..."></textarea>
          </div>

          <div class="field">
            <label for="anamnese">Anamnese</label>
            <textarea id="anamnese" placeholder="História da doença atual, antecedentes, hábitos, contexto..."></textarea>
          </div>

          <div class="field">
            <label for="chipInput">Exames solicitados</label>
            <div class="chipbox" id="chips">
              <input id="chipInput" class="chip-input" placeholder="Digite um exame e pressione Enter (ex.: Hemograma)" />
            </div>
            <span class="hint">Organize os exames esperados para habilitar a área de anexos e resultados.</span>
          </div>

          <div class="actions">
            <button id="btnSalvar" class="btn btn-primary" type="button" onclick="salvar()"></button>
            <button id="btnLimpar" class="btn btn-ghost" type="button" onclick="limpar()"></button>
            <button id="btnExcluir" class="btn btn-danger" type="button" onclick="excluir()" disabled></button>
          </div>
        </div>
      </section>

      <section class="card card--exames">
        <div class="section-header">
          <div>
            <h2>Exames e Documentos</h2>
            <span class="section-subtitle">Gerencie anexos e resultados vinculados ao atendimento</span>
          </div>
          <div class="section-meta">
            <div class="info-chip compact">
              <span class="info-label">Paciente</span>
              <span class="info-value" id="exm-nome">—</span>
            </div>
            <div class="info-chip compact">
              <span class="info-label">ID</span>
              <span class="info-value" id="exm-id">—</span>
            </div>
          </div>
        </div>
        <div class="section-body">
          <div class="preview-panel">
            <div class="field">
              <label for="preview-sintomas">Sintomas (resumo)</label>
              <textarea id="preview-sintomas" readonly placeholder="Preencha os sintomas no prontuário."></textarea>
            </div>
            <div class="field">
              <label for="preview-anamnese">Anamnese (resumo)</label>
              <textarea id="preview-anamnese" readonly placeholder="Preencha a anamnese no prontuário."></textarea>
            </div>
          </div>
          <span class="hint">Edite os campos no bloco “Prontuário do Paciente” para atualizar os resumos.</span>

          <h3 class="section-subtitle" style="margin-top: 4px;">Resultados e anexos dos exames</h3>
          <div id="examesSolicitadosCards" class="exam-card-grid">
            <div class="empty-state muted">Adicione exames solicitados no prontuário para gerenciar resultados por aqui.</div>
          </div>

          <div class="actions actions--inline">
            <button id="btnAtualizarExames" class="btn btn-outline" type="button" onclick="carregarExames()"></button>
            <span id="examesLista" class="muted">— selecione um prontuário —</span>
          </div>

          <div class="ia-panel">
            <button id="btnIa" class="btn btn-secondary" type="button" disabled></button>
            <p id="gating-hint">Preencha anamnese e adicione ao menos um exame com resultado.</p>
          </div>

          <div class="diagnostico-area">
            <label for="diag">Diagnóstico <span id="grav-badge" class="badge"></span></label>
            <textarea id="diag" rows="8" placeholder="Aguardando anamnese e exames para liberar o diagnóstico..." disabled></textarea>
          </div>
        </div>
      </section>

      <section class="card card--listagem">
        <div class="section-header">
          <div>
            <h2>Prontuários cadastrados</h2>
            <span class="section-subtitle">Consulte evoluções anteriores e retome atendimentos</span>
          </div>
          <div class="section-meta">
            <button id="btnListar" class="btn btn-outline" type="button" onclick="listar()"></button>
          </div>
        </div>
        <div class="data-surface" id="lista">
          <div class="empty-state muted">Nenhum prontuário cadastrado até o momento.</div>
        </div>
      </section>

      <section class="card card--logs">
        <div class="section-header">
          <div>
            <h2>Histórico de ações</h2>
            <span class="section-subtitle">Saída dos serviços e integrações</span>
          </div>
        </div>
        <div class="log-surface">
          <pre id="out">Aguardando ações…</pre>
        </div>
      </section>
    </div>
  </main>

<script>
  // --------------- ícones utilitários
  const ICONS = {
    save: '<svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M5 3h11l5 5v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Zm7 0v6h4V5.5L16.5 3H12Zm-4 10a1 1 0 0 0-1 1v5h10v-5a1 1 0 0 0-1-1H8Z" /></svg>',
    broom: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><path d="M3 21h13"/><path d="M14.5 2.5 21 9l-7 7H7.5L3 11.5Z"/><path d="M6 11.5 11.5 17"/></svg>',
    trash: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><path d="M4 7h16"/><path d="M9 7V4h6v3"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M6 7h12l-1 11a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2Z"/></svg>',
    list: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><path d="M8 6h13"/><path d="M8 12h13"/><path d="M8 18h13"/><path d="M3 6h.01"/><path d="M3 12h.01"/><path d="M3 18h.01"/></svg>',
    refresh: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><path d="M20 11V4h-7"/><path d="M4 13v7h7"/><path d="M20 4 13.5 10.5a4.5 4.5 0 0 0-6.36 0L4 13"/></svg>',
    sparkles: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><path d="m12 3 1.6 4.4L18 9l-4.4 1.6L12 15l-1.6-4.4L6 9l4.4-1.6Z"/><path d="m19 16 1 2.7L23 19l-2.1 1.3L21 23l-1.2-2.7L17 19l2.8-.3Z"/><path d="M5 16.5 6 19l2.5.5L6 20l-.5 2.5L4.9 20 3 19.5 4.9 19Z"/></svg>',
    upload: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><path d="M12 16V4"/><path d="m7 9 5-5 5 5"/><path d="M5 20h14"/></svg>',
    document: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><path d="M6 3h9l5 5v13a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1Z"/><path d="M14 3v5h5"/><path d="M8 13h8"/><path d="M8 17h5"/></svg>',
    open: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><path d="m9 18 6-6-6-6"/><path d="M5 18V6"/></svg>',
    close: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" xmlns="http://www.w3.org/2000/svg"><path d="m7 7 10 10"/><path d="M17 7 7 17"/></svg>'
  };

  function iconSvg(name) {
    return ICONS[name] || '';
  }

  function setButtonLabel(button, iconName, label) {
    if (!button) return;
    button.innerHTML = `${iconSvg(iconName)}<span>${label}</span>`;
  }

  function setButtonLoading(button, label) {
    if (!button) return;
    button.classList.add('is-loading');
    button.innerHTML = `<span class="spinner" aria-hidden="true"></span><span>${label}</span>`;
  }

  function resetButtonLoading(button, iconName, label) {
    if (!button) return;
    button.classList.remove('is-loading');
    setButtonLabel(button, iconName, label);
  }

  // --------------- refs
  const out = document.getElementById('out');
  const nome = document.getElementById('nome');
  const cpf = document.getElementById('cpf');
  const dataC = document.getElementById('data');
  const sintomas = document.getElementById('sintomas');
  const anamnese = document.getElementById('anamnese');
  const previewSint = document.getElementById('preview-sintomas');
  const previewAnam = document.getElementById('preview-anamnese');

  const diag = document.getElementById('diag');
  const btnIa = document.getElementById('btnIa');
  const gatingHint = document.getElementById('gating-hint');
  const gravBadge = document.getElementById('grav-badge');

  const chips = document.getElementById('chips');
  const chipInput = document.getElementById('chipInput');
  const lista = document.getElementById('lista');
  const selId = document.getElementById('sel-id');
  const selNome = document.getElementById('sel-nome');
  const exmId = document.getElementById('exm-id');
  const exmNome = document.getElementById('exm-nome');

  const btnSalvar = document.getElementById('btnSalvar');
  const btnExcluir = document.getElementById('btnExcluir');
  const btnListar = document.getElementById('btnListar');
  const btnLimpar = document.getElementById('btnLimpar');
  const btnAtualizarExames = document.getElementById('btnAtualizarExames');

  const examesCards = document.getElementById('examesSolicitadosCards');
  const examesLista = document.getElementById('examesLista');
  const EXAME_SEM_IDENTIFICACAO = 'Exame sem identificação';

  // --------------- estado
  let examesSolicitados = [];
  let prontuarioSelecionado = null;
  let pacienteSelecionadoNome = null;
  let hasExamResults = false;
  let prontuariosCache = [];
  let examesPorTipo = {};

  function initButtons() {
    setButtonLabel(btnSalvar, 'save', 'Salvar prontuário');
    setButtonLabel(btnLimpar, 'broom', 'Limpar formulário');
    setButtonLabel(btnExcluir, 'trash', 'Excluir prontuário');
    setButtonLabel(btnListar, 'list', 'Atualizar listagem');
    setButtonLabel(btnAtualizarExames, 'refresh', 'Atualizar resultados');
    setButtonLabel(btnIa, 'sparkles', 'Sugerir diagnóstico (IA)');
  }

  function atualizarEstadoSelecao() {
    if (prontuarioSelecionado) {
      setButtonLabel(btnSalvar, 'save', 'Atualizar prontuário');
      btnExcluir.disabled = false;
    } else {
      setButtonLabel(btnSalvar, 'save', 'Salvar prontuário');
      btnExcluir.disabled = true;
    }
  }

  function syncPacienteResumo() {
    if (!selNome) return;
    if (prontuarioSelecionado && pacienteSelecionadoNome) {
      selNome.textContent = pacienteSelecionadoNome;
    } else if (nome.value.trim()) {
      selNome.textContent = nome.value.trim();
    } else {
      selNome.textContent = 'Em preenchimento';
    }
  }

  // --------------- chips
  function renderChips() {
    const prevInput = chipInput;
    chips.innerHTML = '';
    examesSolicitados.forEach((e, i) => {
      const div = document.createElement('div');
      div.className = 'chip';
      const span = document.createElement('span');
      span.textContent = e;
      div.appendChild(span);
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'chip-remove';
      btn.innerHTML = iconSvg('close');
      btn.title = 'Remover';
      btn.addEventListener('click', () => remChip(i));
      div.appendChild(btn);
      chips.appendChild(div);
    });
    chips.appendChild(prevInput);
    chipInput.value = '';
    renderExamCards();
  }

  function remChip(i) {
    examesSolicitados.splice(i, 1);
    renderChips();
  }

  chipInput.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter') {
      ev.preventDefault();
      const v = chipInput.value.trim();
      if (v && !examesSolicitados.includes(v)) {
        examesSolicitados.push(v);
        renderChips();
      } else {
        chipInput.value = '';
      }
    }
  });

  function renderExamResultHtml(result) {
    const meta = [];
    if (result.id !== undefined && result.id !== null) meta.push(`ID ${escapeHtml(result.id)}`);
    if (result.data_anexo) meta.push(`Data: ${escapeHtml(result.data_anexo)}`);
    if (result.observacoes) meta.push(`Obs: ${escapeHtml(result.observacoes)}`);

    const metaLine = meta.length ? meta.join(' • ') : '<span class="muted">Sem metadados informados.</span>';
    const fileLine = result.arquivo_path
      ? `<div><a href="${escapeHtml(result.arquivo_path)}" target="_blank">Abrir arquivo anexado</a></div>`
      : '';
    const textoLine = result.resultado_texto
      ? `<pre>${escapeHtml(result.resultado_texto)}</pre>`
      : '';

    const emptyInfo = (!fileLine && !textoLine)
      ? '<div class="muted">Nenhum resultado textual ou arquivo associado a este registro.</div>'
      : '';

    return `<div class="exam-result-item"><div>${metaLine}</div>${fileLine}${textoLine}${emptyInfo}</div>`;
  }

  function renderExamCards() {
    if (!examesCards) return;
    examesCards.innerHTML = '';

    if (!prontuarioSelecionado) {
      examesCards.innerHTML = '<div class="muted">Selecione um prontuário para registrar resultados.</div>';
      return;
    }

    const nomes = new Set();
    examesSolicitados.forEach((nome) => { if (nome) nomes.add(nome); });
    Object.keys(examesPorTipo || {}).forEach((nome) => { if (nome) nomes.add(nome); });

    if (nomes.size === 0) {
      examesCards.innerHTML = '<div class="muted">Nenhum exame solicitado. Use o campo acima para adicioná-los.</div>';
      return;
    }

    let idx = 0;
    nomes.forEach((nomeExame) => {
      const nomeSeguro = nomeExame || EXAME_SEM_IDENTIFICACAO;
      const card = document.createElement('div');
      card.className = 'exam-card';

      const titulo = document.createElement('h4');
      titulo.textContent = nomeSeguro;
      card.appendChild(titulo);

      const explicacao = document.createElement('div');
      explicacao.className = 'hint';
      explicacao.textContent = 'Registre o resultado textual ou anexe um arquivo.';
      card.appendChild(explicacao);

      const dataLabel = document.createElement('label');
      dataLabel.textContent = 'Data de anexo';
      card.appendChild(dataLabel);
      const dataInput = document.createElement('input');
      dataInput.type = 'date';
      dataInput.placeholder = 'YYYY-MM-DD';
      dataInput.id = `exam-data-${idx}`;
      card.appendChild(dataInput);

      const obsLabel = document.createElement('label');
      obsLabel.textContent = 'Observações';
      card.appendChild(obsLabel);
      const obsInput = document.createElement('input');
      obsInput.placeholder = 'Breve observação (opcional)';
      obsInput.id = `exam-obs-${idx}`;
      card.appendChild(obsInput);

      const textoLabel = document.createElement('label');
      textoLabel.textContent = 'Resultado textual';
      card.appendChild(textoLabel);
      const textoArea = document.createElement('textarea');
      textoArea.placeholder = 'Cole aqui o laudo/resultado (opcional se enviar arquivo)';
      textoArea.id = `exam-texto-${idx}`;
      card.appendChild(textoArea);

      const actionsTexto = document.createElement('div');
      actionsTexto.className = 'exam-actions';
      const salvarBtn = document.createElement('button');
      salvarBtn.type = 'button';
      salvarBtn.className = 'btn btn-secondary btn-sm';
      setButtonLabel(salvarBtn, 'document', 'Salvar resultado textual');
      salvarBtn.onclick = () => salvarExameTextoCard(nomeExame, {
        dataId: dataInput.id,
        obsId: obsInput.id,
        textoId: textoArea.id
      });
      actionsTexto.appendChild(salvarBtn);
      card.appendChild(actionsTexto);

      const arquivoLabel = document.createElement('label');
      arquivoLabel.textContent = 'Arquivo do exame (PDF/IMG)';
      card.appendChild(arquivoLabel);
      const arquivoInput = document.createElement('input');
      arquivoInput.type = 'file';
      arquivoInput.id = `exam-arquivo-${idx}`;
      card.appendChild(arquivoInput);
      const arquivoHint = document.createElement('div');
      arquivoHint.className = 'hint';
      arquivoHint.textContent = 'Se enviar arquivo, o resultado textual pode ficar vazio.';
      card.appendChild(arquivoHint);

      const actionsArquivo = document.createElement('div');
      actionsArquivo.className = 'exam-actions';
      const uploadBtn = document.createElement('button');
      uploadBtn.type = 'button';
      uploadBtn.className = 'btn btn-outline btn-sm';
      setButtonLabel(uploadBtn, 'upload', 'Anexar arquivo');
      uploadBtn.onclick = () => uploadExameCard(nomeExame, {
        dataId: dataInput.id,
        obsId: obsInput.id,
        fileId: arquivoInput.id
      });
      actionsArquivo.appendChild(uploadBtn);
      card.appendChild(actionsArquivo);

      const resultados = document.createElement('div');
      resultados.className = 'exam-results-list';
      const chaveConsulta = nomeExame || EXAME_SEM_IDENTIFICACAO;
      const registros = Array.isArray(examesPorTipo?.[chaveConsulta]) ? examesPorTipo[chaveConsulta] : [];
      if (!registros.length) {
        resultados.innerHTML = '<div class="muted">Sem anexos ou resultados registrados.</div>';
      } else {
        resultados.innerHTML = registros.map(renderExamResultHtml).join('');
      }
      card.appendChild(resultados);

      examesCards.appendChild(card);
      idx += 1;
    });
  }

  async function salvarExameTextoCard(nomeExame, refs = {}) {
    if (!prontuarioSelecionado) { out.textContent = 'Selecione um prontuário.'; return; }
    const textarea = refs.textoId ? document.getElementById(refs.textoId) : null;
    const texto = (textarea?.value || '').trim();
    if (!texto) { out.textContent = 'Informe o resultado textual antes de salvar.'; return; }

    const data = refs.dataId ? (document.getElementById(refs.dataId)?.value || '') : '';
    const obs = refs.obsId ? (document.getElementById(refs.obsId)?.value || '') : '';
    const tipoFinal = (nomeExame || '').trim() || EXAME_SEM_IDENTIFICACAO;

    try {
      const r = await fetch('/exames/texto', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          prontuario_id: prontuarioSelecionado,
          tipo: tipoFinal,
          observacoes: obs,
          resultado_texto: texto,
          data_anexo: data
        })
      });
      const t = await r.text();
      out.textContent = t;
      if (r.ok && textarea) textarea.value = '';
      carregarExames();
    } catch (e) {
      out.textContent = 'Erro ao salvar resultado: ' + e.message;
    }
  }

  async function uploadExameCard(nomeExame, refs = {}) {
    if (!prontuarioSelecionado) { out.textContent = 'Selecione um prontuário.'; return; }
    const fileInput = refs.fileId ? document.getElementById(refs.fileId) : null;
    if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
      out.textContent = 'Escolha um arquivo.';
      return;
    }

    const data = refs.dataId ? (document.getElementById(refs.dataId)?.value || '') : '';
    const obs = refs.obsId ? (document.getElementById(refs.obsId)?.value || '') : '';
    const tipoFinal = (nomeExame || '').trim() || EXAME_SEM_IDENTIFICACAO;

    try {
      const fd = new FormData();
      fd.append('prontuario_id', prontuarioSelecionado);
      fd.append('tipo', tipoFinal);
      fd.append('observacoes', obs);
      fd.append('data_anexo', data);
      fd.append('arquivo', fileInput.files[0]);

      const r = await fetch('/exames/upload', { method:'POST', body: fd });
      const t = await r.text();
      out.textContent = t;
      if (r.ok) fileInput.value = '';
      carregarExames();
    } catch (e) {
      out.textContent = 'Erro no upload: ' + e.message;
    }
  }

  // --------------- previews
  function syncPreviews(){ previewSint.value = sintomas.value; previewAnam.value = anamnese.value; }
  sintomas.addEventListener('input', syncPreviews);
  anamnese.addEventListener('input', () => { syncPreviews(); atualizarDisponibilidadeIA(); });
  nome.addEventListener('input', () => { syncPacienteResumo(); });

  // --------------- badge gravidade
  function setBadge(gravidade) {
    gravBadge.className = 'badge';
    if (!gravidade) { gravBadge.textContent = ''; return; }
    const g = String(gravidade).toLowerCase();
    if (g.includes('alta')) { gravBadge.classList.add('grav-alta'); gravBadge.textContent = 'gravidade: alta'; }
    else if (g.includes('moder')) { gravBadge.classList.add('grav-moderada'); gravBadge.textContent = 'gravidade: moderada'; }
    else if (g.includes('baixa')) { gravBadge.classList.add('grav-baixa'); gravBadge.textContent = 'gravidade: baixa'; }
    else { gravBadge.textContent = ''; }
  }

  // --------------- format diagnóstico
  function formatSugestaoCompleta(sug) {
    if (!sug) return '(sem sugestão)';
    if (typeof sug === 'string') return sug;
    if (sug && typeof sug.texto === 'string') return sug.texto;

    const hip = Array.isArray(sug.hipoteses) ? sug.hipoteses : [];
    const grav = sug.gravidade || 'indefinida';
    const alarmes = Array.isArray(sug.sinais_alarme) ? sug.sinais_alarme : [];
    const jus = (sug.justificativa || '').trim();
    const rec = (sug.recomendacao || '').trim();
    const exames = Array.isArray(sug.exames_sugeridos) ? sug.exames_sugeridos : [];
    const conf = typeof sug.confianca === 'number' ? sug.confianca : undefined;
    const diretrizes = (sug && typeof sug.diretrizes_utilizadas === 'object' && !Array.isArray(sug.diretrizes_utilizadas))
      ? sug.diretrizes_utilizadas
      : null;

    let linhas = [];
    if (hip.length) linhas.push(`Hipóteses: ${hip.join('; ')}`);
    linhas.push(`Gravidade: ${grav}`);
    if (alarmes.length) linhas.push(`Sinais de alarme: ${alarmes.join('; ')}`);
    if (jus) linhas.push(`Justificativa: ${jus}`);
    if (rec) linhas.push(`Recomendação: ${rec}`);
    if (exames.length) linhas.push(`Exames sugeridos: ${exames.join('; ')}`);
    if (conf !== undefined) linhas.push(`Confiança: ${conf.toFixed(2)}`);
    if (diretrizes) {
      const labels = {
        sintomas: 'Diretrizes (sintomas)',
        anamnese: 'Diretrizes (anamnese)',
        exames_resultados: 'Diretrizes (resultados de exames)',
        exames_anexos: 'Diretrizes (anexos de exames)'
      };
      Object.entries(labels).forEach(([key, label]) => {
        if (key in diretrizes) {
          const valor = String(diretrizes[key] ?? '').trim();
          if (valor) linhas.push(`${label}: ${valor}`);
        }
      });
    }
    return linhas.join('\n');
  }

  // --------------- IA
  btnIa.addEventListener('click', async () => {
    btnIa.disabled = true;
    setButtonLoading(btnIa, 'Consultando IA...');
    try {
      const payload = {
        sintomas: sintomas.value || '',
        anamnese: anamnese.value || ''
      };
      if (prontuarioSelecionado) payload.prontuario_id = prontuarioSelecionado;

      const r = await fetch('/ai-diagnostico', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });

      const text = await r.text();
      let data;
      try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }

      if (!r.ok) {
        const msg = data.detail || data.error || `${r.status} ${r.statusText}` || 'Falha ao consultar IA';
        out.textContent = `Erro na IA: ${msg}`;
        return;
      }

      const sug = data.sugestao;
      diag.value = formatSugestaoCompleta(sug);
      setBadge(sug?.gravidade);

      const sugestaoJson = (() => {
        try { return JSON.stringify(sug, null, 2); } catch { return ''; }
      })();
      const sugestaoBase = sugestaoJson
        ? `Sugestão da IA:\n${sugestaoJson}`
        : 'Sugestão da IA registrada.';

      const textoDiagnostico = (diag.value || '').trim();
      if (textoDiagnostico) {
        setButtonLoading(btnIa, 'Salvando diagnóstico...');
        const resultadoSalvar = await salvar({ silencioso: true });

        if (resultadoSalvar?.sucesso) {
          const retornoServidor = resultadoSalvar?.texto
            ? `\n\nRetorno do servidor:\n${resultadoSalvar.texto}`
            : '';
          out.textContent = `${sugestaoBase}\n\nDiagnóstico da IA salvo automaticamente no prontuário.${retornoServidor}`;
        } else if (resultadoSalvar?.motivo === 'campos-obrigatorios') {
          out.textContent = `${sugestaoBase}\n\nNão foi possível salvar automaticamente: preencha Nome, CPF e Data da consulta e salve novamente.`;
        } else {
          const mensagemErro = resultadoSalvar?.mensagem
            || 'Não foi possível salvar automaticamente o diagnóstico sugerido.';
          const retornoServidor = resultadoSalvar?.texto
            ? `\n\nRetorno do servidor:\n${resultadoSalvar.texto}`
            : '';
          out.textContent = `${sugestaoBase}\n\n${mensagemErro}${retornoServidor}`;
        }
      } else {
        out.textContent = sugestaoBase;
      }
    } catch (e) {
      out.textContent = 'Erro na IA: ' + e.message;
    } finally {
      resetButtonLoading(btnIa, 'sparkles', 'Sugerir diagnóstico (IA)');
      atualizarDisponibilidadeIA();
    }
  });

  // --------------- CRUD prontuário
  function validaCampos() {
    if (!nome.value.trim() || !cpf.value.trim() || !dataC.value.trim()) {
      out.textContent = 'Preencha Nome, CPF e Data.'; return false;
    }
    return true;
  }

  async function salvar(opts = {}) {
    const { silencioso = false } = opts;
    try {
      if (!validaCampos()) return { sucesso: false, motivo: 'campos-obrigatorios' };

      // IMPORTANTE: backend exige "diagnostico" -> usamos "Em avaliação" se vazio
      const diagnosticoFinal = (diag.value || '').trim() || 'Em avaliação';

      const body = {
        nome: nome.value,
        cpf: cpf.value,
        data_consulta: dataC.value,
        diagnostico: diagnosticoFinal,
        sintomas: sintomas.value || '',
        anamnese: anamnese.value || '',
        exames_solicitados: examesSolicitados
      };

      const isUpdate = Boolean(prontuarioSelecionado);
      const url = isUpdate ? `/prontuario/${prontuarioSelecionado}` : '/prontuario';
      const method = isUpdate ? 'PUT' : 'POST';

      const r = await fetch(url, {
        method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      });
      const txt = await r.text();
      if (!silencioso) out.textContent = txt;
      await listar();
      try {
        const j = JSON.parse(txt);
        if (j.id) selecionarProntuario(j.id, body.nome, { atualizarForm: false });
        return { sucesso: r.ok, texto: txt, json: j, status: r.status };
      } catch {}
      return { sucesso: r.ok, texto: txt, status: r.status };
    } catch (e) {
      if (!silencioso) out.textContent = 'Erro ao salvar: ' + e.message;
      return { sucesso: false, erro: e, mensagem: 'Erro ao salvar: ' + e.message };
    }
  }

  async function listar() {
    try {
      const r = await fetch('/prontuarios');
      const arr = await r.json();
      prontuariosCache = Array.isArray(arr) ? arr : [];
      if (!Array.isArray(arr) || arr.length === 0) {
        lista.innerHTML = '<div class="empty-state muted">Nenhum prontuário cadastrado ainda.</div>';
        return;
      }
      const rows = arr.map(p => {
        const exames = Array.isArray(p.exames_solicitados) && p.exames_solicitados.length
          ? p.exames_solicitados.map(escapeHtml).map(e => `<span class="table-chip">${e}</span>`).join('')
          : '<span class="muted">Sem exames</span>';
        return `
        <tr>
          <td><span class="record-id">#${escapeHtml(String(p.id))}</span></td>
          <td><div class="record-name">${escapeHtml(p.nome)}</div><div class="record-cpf muted">${escapeHtml(p.cpf)}</div></td>
          <td><span class="record-date">${escapeHtml(p.data_consulta)}</span></td>
          <td><div class="diagnostico-resumo">${escapeHtml(p.diagnostico || '')}</div></td>
          <td>
            <div class="records-exams">${exames}</div>
            <button class="btn btn-link" type="button" onclick="selecionarProntuario(${p.id})">${iconSvg('open')}<span>Abrir prontuário</span></button>
          </td>
        </tr>`;
      }).join('');
      lista.innerHTML = `
        <table>
          <thead><tr><th>ID</th><th>Paciente</th><th>Data</th><th>Diagnóstico</th><th>Ações</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;

      if (prontuarioSelecionado) {
        const atual = prontuariosCache.find(p => Number(p.id) === Number(prontuarioSelecionado));
        if (atual) {
          preencherFormulario(atual);
          atualizarEstadoSelecao();
        }
      }
    } catch (e) { lista.innerHTML = 'Erro ao listar: ' + escapeHtml(e.message); }
  }

  function preencherFormulario(prontuario) {
    if (!prontuario) return;
    nome.value = prontuario.nome || '';
    cpf.value = prontuario.cpf || '';
    dataC.value = prontuario.data_consulta || '';
    sintomas.value = prontuario.sintomas || '';
    anamnese.value = prontuario.anamnese || '';
    diag.value = prontuario.diagnostico || '';
    examesSolicitados = Array.isArray(prontuario.exames_solicitados)
      ? [...prontuario.exames_solicitados]
      : [];
    renderChips();
    syncPreviews();
    syncPacienteResumo();
  }

  function selecionarProntuario(id, _nomePaciente='', opts = {}) {
    prontuarioSelecionado = Number(id);
    const atual = prontuariosCache.find(p => Number(p.id) === prontuarioSelecionado);
    pacienteSelecionadoNome = (atual && atual.nome) || _nomePaciente || pacienteSelecionadoNome;
    selId.textContent = String(prontuarioSelecionado);
    exmId.textContent = String(prontuarioSelecionado);
    exmNome.textContent = pacienteSelecionadoNome || '—';
    syncPacienteResumo();
    if (opts.atualizarForm !== false) preencherFormulario(atual);
    syncPreviews();
    carregarExames();
    atualizarEstadoSelecao();
    setTimeout(atualizarDisponibilidadeIA, 300);
  }

  function limpar() {
    nome.value = '';
    cpf.value = '';
    dataC.value = '';
    sintomas.value = '';
    anamnese.value = '';
    diag.value = '';
    prontuarioSelecionado = null;
    pacienteSelecionadoNome = null;
    examesSolicitados = [];
    examesPorTipo = {};
    renderChips();
    renderExamCards();
    setBadge('');
    syncPreviews();
    syncPacienteResumo();
    out.textContent = 'Formulário limpo.';
    selId.textContent = '—';
    exmId.textContent = '—';
    exmNome.textContent = '—';
    examesLista.textContent = '— selecione um prontuário —';
    atualizarEstadoSelecao();
    atualizarDisponibilidadeIA();
  }

  async function excluir() {
    if (!prontuarioSelecionado) { out.textContent = 'Selecione um prontuário.'; return; }
    if (!confirm('Tem certeza que deseja excluir este prontuário? Esta ação é irreversível.')) return;
    try {
      const r = await fetch(`/prontuario/${prontuarioSelecionado}`, { method: 'DELETE' });
      const txt = await r.text();
      out.textContent = txt;
      limpar();
      listar();
    } catch (e) { out.textContent = 'Erro ao excluir: ' + e.message; }
  }

  // --------------- Exames
  async function carregarExames() {
    hasExamResults = false;
    examesPorTipo = {};

    if (!prontuarioSelecionado) {
      examesLista.textContent = '— selecione um prontuário —';
      renderExamCards();
      atualizarDisponibilidadeIA();
      return;
    }

    try {
      const r = await fetch(`/exames?prontuario_id=${prontuarioSelecionado}`);
      const arr = await r.json();

      if (Array.isArray(arr)) {
        arr.forEach((e) => {
          const nomeChave = (typeof e.tipo === 'string' && e.tipo.trim()) ? e.tipo.trim() : EXAME_SEM_IDENTIFICACAO;
          const normalizado = {
            ...e,
            data_anexo: e.data_anexo || e.data_resultado || ''
          };
          if (!examesPorTipo[nomeChave]) examesPorTipo[nomeChave] = [];
          examesPorTipo[nomeChave].push(normalizado);
        });
        hasExamResults = arr.some((e) => {
          const temArquivo = typeof e.arquivo_path === 'string' && e.arquivo_path.trim() !== '';
          const temTexto = typeof e.resultado_texto === 'string' && e.resultado_texto.trim() !== '';
          return temArquivo || temTexto;
        });
      }

      if (!Array.isArray(arr) || arr.length === 0) {
        examesLista.textContent = 'Nenhum resultado registrado ainda.';
      } else {
        examesLista.textContent = 'Resultados exibidos nos cartões acima.';
      }

      renderExamCards();
      atualizarDisponibilidadeIA();
    } catch (e) {
      examesLista.textContent = 'Erro ao carregar exames: ' + e.message;
      examesPorTipo = {};
      renderExamCards();
      atualizarDisponibilidadeIA();
    }
  }

  // --------------- Gating IA
  function atualizarDisponibilidadeIA() {
    const anamnesePreenchida = anamnese.value.trim().length > 20;
    const podeUsarIA = anamnesePreenchida && hasExamResults;

    btnIa.disabled = !podeUsarIA;
    diag.disabled = !podeUsarIA;

    if (!podeUsarIA) {
      gatingHint.textContent = 'Preencha anamnese e adicione ao menos um exame com resultado (arquivo ou texto).';
      diag.placeholder = 'Aguardando anamnese e exames para liberar o diagnóstico...';
    } else {
      gatingHint.textContent = '';
      diag.placeholder = 'Será preenchido pela IA ou manualmente.';
    }
  }
  const examesObserver = new MutationObserver(atualizarDisponibilidadeIA);
  if (examesCards) examesObserver.observe(examesCards, { childList: true, subtree: true });

  // --------------- utils
  function escapeHtml(s='') {
    return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
                    .replaceAll('"','&quot;').replaceAll("'","&#039;");
  }
  function escapeAttr(s='') { return String(s).replaceAll('\\','\\\\').replaceAll("'", "\\'"); }

  // boot
  initButtons();
  renderChips();
  listar();
  syncPreviews();
  syncPacienteResumo();
  atualizarDisponibilidadeIA();
  atualizarEstadoSelecao();
</script>
</body>
</html>
