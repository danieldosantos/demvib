<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>MedVibe</title>
  <style>
    :root { --b:#222; --fg:#111; --bd:#ddd; --muted:#666; }
    body { font-family: system-ui, Arial, sans-serif; max-width: 980px; margin: 24px auto; padding: 0 16px; }
    h1,h2,h3 { margin: 0 0 12px; }
    section { border:1px solid var(--bd); border-radius:12px; padding:16px; margin-bottom:16px; background:#fff; }
    label { display:block; font-weight:600; margin-top:10px; }
    input, textarea, select { width:100%; padding:10px; margin-top:6px; border:1px solid var(--bd); border-radius:8px; box-sizing:border-box; }
    textarea { min-height: 90px; }
    .row { display:flex; gap:12px; flex-wrap: wrap; }
    .row > div { flex:1 1 240px; }
    .actions { margin-top: 14px; display:flex; gap:10px; flex-wrap: wrap; }
    button { padding:10px 14px; border:1px solid var(--bd); border-radius:10px; background:#fafafa; cursor:pointer; }
    button:hover { background:#f2f2f2; }
    .muted { color: var(--muted); font-size: 12px; }
    pre { background:#0d1117; color:#c9d1d9; padding:12px; border-radius:10px; overflow:auto; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:8px; border:1px solid transparent;}
    .grav-baixa { background:#e6f7e6; color:#146c2e; border-color:#bfe6bf; }
    .grav-moderada { background:#fff7e6; color:#805b00; border-color:#ffe0a3; }
    .grav-alta { background:#ffeaea; color:#a10000; border-color:#ffb3b3; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-top:1px solid #eee; padding:8px; text-align:left; vertical-align: top; }
    .chipbox { display:flex; flex-wrap:wrap; gap:6px; }
    .chipbox input { flex: 1 1 220px; }
    .chip { background:#f5f5f5; border:1px solid #e6e6e6; padding:6px 10px; border-radius:999px; font-size:12px; display:inline-flex; align-items:center; gap:6px;}
    .chip button { border:none; background:transparent; cursor:pointer; padding:0 4px; }
    .hint { font-size:12px; color:#777; }
    .subtle { background:#fbfbfb; border:1px dashed #e5e5e5; border-radius:10px; padding:12px; }
    .exam-card-grid { display:flex; flex-direction:column; gap:12px; }
    .exam-card { border:1px solid #e6e6e6; border-radius:12px; padding:14px; background:#fafafa; }
    .exam-card h4 { margin:0 0 8px; font-size:16px; }
    .exam-card label { margin-top:10px; font-size:13px; text-transform:none; }
    .exam-card textarea { min-height:90px; }
    .exam-actions { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .exam-results-list { margin-top:12px; border:1px dashed #d7d7d7; border-radius:10px; padding:10px; background:#fff; }
    .exam-result-item { font-size:13px; margin-bottom:8px; }
    .exam-result-item:last-child { margin-bottom:0; }
    .exam-result-item pre { margin:6px 0 0; padding:8px; background:#0d1117; color:#c9d1d9; border-radius:8px; white-space:pre-wrap; }
  </style>
</head>
<body>

  <h1>üìã MedVibe ‚Äî Prontu√°rios com Anamnese & Exames</h1>

  <!-- PRONTU√ÅRIO -->
  <section>
    <h2>Prontu√°rio do Paciente</h2>
    <div class="row">
      <div>
        <label>Nome</label>
        <input id="nome" placeholder="Ex.: Ana Souza">
      </div>
      <div>
        <label>CPF</label>
        <input id="cpf" placeholder="000.000.000-00">
      </div>
      <div>
        <label>Data da consulta</label>
        <input id="data" placeholder="YYYY-MM-DD">
        <div class="hint">Ex.: 2025-10-21</div>
      </div>
    </div>

    <label>Sintomas</label>
    <textarea id="sintomas" placeholder="Descreva sintomas, dura√ß√£o, intensidade..."></textarea>

    <label>Anamnese</label>
    <textarea id="anamnese" placeholder="Hist√≥ria da doen√ßa atual, antecedentes, h√°bitos, contexto..."></textarea>

    <label>Exames solicitados</label>
    <div class="chipbox" id="chips">
      <input id="chipInput" placeholder="Digite um exame e pressione Enter (ex: Hemograma)" />
    </div>

    <div class="actions">
      <button id="btnSalvar" onclick="salvar()">üíæ Salvar prontu√°rio</button>
      <button onclick="listar()">üìÑ Listar prontu√°rios</button>
      <button id="btnExcluir" onclick="excluir()" disabled>üóëÔ∏è Excluir prontu√°rio</button>
      <button onclick="limpar()">üßπ Limpar</button>
      <span class="muted">Selecionado: <span id="sel-id">‚Äî</span></span>
    </div>
  </section>

  <!-- EXAMES + IA -->
  <section>
    <h2>
      Exames do Prontu√°rio ‚Äî
      <span class="muted">Paciente:</span> <strong id="exm-nome">‚Äî</strong>
      <span class="muted">‚Ä¢ ID</span> <span id="exm-id" class="muted">‚Äî</span>
    </h2>

    <div class="subtle">
      <div class="row">
        <div>
          <label>Sintomas (resumo)</label>
          <textarea id="preview-sintomas" readonly placeholder="Preencha os sintomas no prontu√°rio."></textarea>
        </div>
        <div>
          <label>Anamnese (resumo)</label>
          <textarea id="preview-anamnese" readonly placeholder="Preencha a anamnese no prontu√°rio."></textarea>
        </div>
      </div>
      <div class="hint">Edite os campos no bloco ‚ÄúProntu√°rio do Paciente‚Äù.</div>
    </div>

    <br/>

    <h3>Resultados e anexos dos exames solicitados</h3>
    <div id="examesSolicitadosCards" class="exam-card-grid">
      <div class="muted">Adicione exames solicitados no prontu√°rio para gerenciar resultados por aqui.</div>
    </div>

    <div class="actions" style="margin-top:8px;">
      <button onclick="carregarExames()">üîÑ Atualizar resultados</button>
    </div>

    <div id="examesLista" class="muted" style="margin-top:12px;">‚Äî selecione um prontu√°rio ‚Äî</div>

    <hr style="margin:16px 0; border:none; border-top:1px solid #eee" />

    <div class="actions">
      <button id="btnIa" type="button" disabled>ü™Ñ Sugerir diagn√≥stico (IA)</button>
      <span id="gating-hint" class="muted">Preencha anamnese e adicione ao menos um exame com resultado.</span>
    </div>

    <label>Diagn√≥stico <span id="grav-badge" class="badge"></span></label>
    <textarea id="diag" rows="8" placeholder="Aguardando anamnese e exames para liberar o diagn√≥stico..." disabled></textarea>
  </section>

  <!-- LISTAGEM -->
  <section>
    <h2>Prontu√°rios</h2>
    <div id="lista">‚Äî sem dados ‚Äî</div>
  </section>

  <!-- LOG/SA√çDA -->
  <section>
    <h2>Sa√≠da</h2>
    <pre id="out">Aguardando a√ß√µes‚Ä¶</pre>
  </section>

<script>
  // --------------- refs
  const out = document.getElementById('out');
  const nome = document.getElementById('nome');
  const cpf = document.getElementById('cpf');
  const dataC = document.getElementById('data');
  const sintomas = document.getElementById('sintomas');
  const anamnese = document.getElementById('anamnese');
  const previewSint = document.getElementById('preview-sintomas');
  const previewAnam = document.getElementById('preview-anamnese');

  const diag = document.getElementById('diag');
  const btnIa = document.getElementById('btnIa');
  const gatingHint = document.getElementById('gating-hint');
  const gravBadge = document.getElementById('grav-badge');

  const chips = document.getElementById('chips');
  const chipInput = document.getElementById('chipInput');
  const lista = document.getElementById('lista');
  const selId = document.getElementById('sel-id');
  const exmId = document.getElementById('exm-id');
  const exmNome = document.getElementById('exm-nome');

  const btnSalvar = document.getElementById('btnSalvar');
  const btnExcluir = document.getElementById('btnExcluir');

  const examesCards = document.getElementById('examesSolicitadosCards');
  const examesLista = document.getElementById('examesLista');
  const EXAME_SEM_IDENTIFICACAO = 'Exame sem identifica√ß√£o';

  // --------------- estado
  let examesSolicitados = [];
  let prontuarioSelecionado = null;
  let pacienteSelecionadoNome = null;
  let hasExamResults = false;
  let prontuariosCache = [];
  let examesPorTipo = {};

  function atualizarEstadoSelecao() {
    if (prontuarioSelecionado) {
      btnSalvar.textContent = 'üíæ Atualizar prontu√°rio';
      btnExcluir.disabled = false;
    } else {
      btnSalvar.textContent = 'üíæ Salvar prontu√°rio';
      btnExcluir.disabled = true;
    }
  }

  // --------------- chips
  function renderChips() {
    const prevInput = chipInput;
    chips.innerHTML = '';
    examesSolicitados.forEach((e, i) => {
      const div = document.createElement('div');
      div.className = 'chip';
      div.innerHTML = `${e} <button title="Remover" onclick="remChip(${i})">‚úï</button>`;
      chips.appendChild(div);
    });
    chips.appendChild(prevInput);
    chipInput.value = '';
    renderExamCards();
  }
  function remChip(i){ examesSolicitados.splice(i,1); renderChips(); }
  chipInput.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter') {
      ev.preventDefault();
      const v = chipInput.value.trim();
      if (v && !examesSolicitados.includes(v)) { examesSolicitados.push(v); renderChips(); }
      else { chipInput.value = ''; }
    }
  });

  function renderExamResultHtml(result) {
    const meta = [];
    if (result.id !== undefined && result.id !== null) meta.push(`ID ${escapeHtml(result.id)}`);
    if (result.data_anexo) meta.push(`Data: ${escapeHtml(result.data_anexo)}`);
    if (result.observacoes) meta.push(`Obs: ${escapeHtml(result.observacoes)}`);

    const metaLine = meta.length ? meta.join(' ‚Ä¢ ') : '<span class="muted">Sem metadados informados.</span>';
    const fileLine = result.arquivo_path
      ? `<div><a href="${escapeHtml(result.arquivo_path)}" target="_blank">Abrir arquivo anexado</a></div>`
      : '';
    const textoLine = result.resultado_texto
      ? `<pre>${escapeHtml(result.resultado_texto)}</pre>`
      : '';

    const emptyInfo = (!fileLine && !textoLine)
      ? '<div class="muted">Nenhum resultado textual ou arquivo associado a este registro.</div>'
      : '';

    return `<div class="exam-result-item"><div>${metaLine}</div>${fileLine}${textoLine}${emptyInfo}</div>`;
  }

  function renderExamCards() {
    if (!examesCards) return;
    examesCards.innerHTML = '';

    if (!prontuarioSelecionado) {
      examesCards.innerHTML = '<div class="muted">Selecione um prontu√°rio para registrar resultados.</div>';
      return;
    }

    const nomes = new Set();
    examesSolicitados.forEach((nome) => { if (nome) nomes.add(nome); });
    Object.keys(examesPorTipo || {}).forEach((nome) => { if (nome) nomes.add(nome); });

    if (nomes.size === 0) {
      examesCards.innerHTML = '<div class="muted">Nenhum exame solicitado. Use o campo acima para adicion√°-los.</div>';
      return;
    }

    let idx = 0;
    nomes.forEach((nomeExame) => {
      const nomeSeguro = nomeExame || EXAME_SEM_IDENTIFICACAO;
      const card = document.createElement('div');
      card.className = 'exam-card';

      const titulo = document.createElement('h4');
      titulo.textContent = nomeSeguro;
      card.appendChild(titulo);

      const explicacao = document.createElement('div');
      explicacao.className = 'hint';
      explicacao.textContent = 'Registre o resultado textual ou anexe um arquivo.';
      card.appendChild(explicacao);

      const dataLabel = document.createElement('label');
      dataLabel.textContent = 'Data de anexo';
      card.appendChild(dataLabel);
      const dataInput = document.createElement('input');
      dataInput.type = 'date';
      dataInput.placeholder = 'YYYY-MM-DD';
      dataInput.id = `exam-data-${idx}`;
      card.appendChild(dataInput);

      const obsLabel = document.createElement('label');
      obsLabel.textContent = 'Observa√ß√µes';
      card.appendChild(obsLabel);
      const obsInput = document.createElement('input');
      obsInput.placeholder = 'Breve observa√ß√£o (opcional)';
      obsInput.id = `exam-obs-${idx}`;
      card.appendChild(obsInput);

      const textoLabel = document.createElement('label');
      textoLabel.textContent = 'Resultado textual';
      card.appendChild(textoLabel);
      const textoArea = document.createElement('textarea');
      textoArea.placeholder = 'Cole aqui o laudo/resultado (opcional se enviar arquivo)';
      textoArea.id = `exam-texto-${idx}`;
      card.appendChild(textoArea);

      const actionsTexto = document.createElement('div');
      actionsTexto.className = 'exam-actions';
      const salvarBtn = document.createElement('button');
      salvarBtn.textContent = 'üìù Salvar resultado textual';
      salvarBtn.onclick = () => salvarExameTextoCard(nomeExame, {
        dataId: dataInput.id,
        obsId: obsInput.id,
        textoId: textoArea.id
      });
      actionsTexto.appendChild(salvarBtn);
      card.appendChild(actionsTexto);

      const arquivoLabel = document.createElement('label');
      arquivoLabel.textContent = 'Arquivo do exame (PDF/IMG)';
      card.appendChild(arquivoLabel);
      const arquivoInput = document.createElement('input');
      arquivoInput.type = 'file';
      arquivoInput.id = `exam-arquivo-${idx}`;
      card.appendChild(arquivoInput);
      const arquivoHint = document.createElement('div');
      arquivoHint.className = 'hint';
      arquivoHint.textContent = 'Se enviar arquivo, o resultado textual pode ficar vazio.';
      card.appendChild(arquivoHint);

      const actionsArquivo = document.createElement('div');
      actionsArquivo.className = 'exam-actions';
      const uploadBtn = document.createElement('button');
      uploadBtn.textContent = 'üìé Anexar arquivo';
      uploadBtn.onclick = () => uploadExameCard(nomeExame, {
        dataId: dataInput.id,
        obsId: obsInput.id,
        fileId: arquivoInput.id
      });
      actionsArquivo.appendChild(uploadBtn);
      card.appendChild(actionsArquivo);

      const resultados = document.createElement('div');
      resultados.className = 'exam-results-list';
      const chaveConsulta = nomeExame || EXAME_SEM_IDENTIFICACAO;
      const registros = Array.isArray(examesPorTipo?.[chaveConsulta]) ? examesPorTipo[chaveConsulta] : [];
      if (!registros.length) {
        resultados.innerHTML = '<div class="muted">Sem anexos ou resultados registrados.</div>';
      } else {
        resultados.innerHTML = registros.map(renderExamResultHtml).join('');
      }
      card.appendChild(resultados);

      examesCards.appendChild(card);
      idx += 1;
    });
  }

  async function salvarExameTextoCard(nomeExame, refs = {}) {
    if (!prontuarioSelecionado) { out.textContent = 'Selecione um prontu√°rio.'; return; }
    const textarea = refs.textoId ? document.getElementById(refs.textoId) : null;
    const texto = (textarea?.value || '').trim();
    if (!texto) { out.textContent = 'Informe o resultado textual antes de salvar.'; return; }

    const data = refs.dataId ? (document.getElementById(refs.dataId)?.value || '') : '';
    const obs = refs.obsId ? (document.getElementById(refs.obsId)?.value || '') : '';
    const tipoFinal = (nomeExame || '').trim() || EXAME_SEM_IDENTIFICACAO;

    try {
      const r = await fetch('/exames/texto', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          prontuario_id: prontuarioSelecionado,
          tipo: tipoFinal,
          observacoes: obs,
          resultado_texto: texto,
          data_anexo: data
        })
      });
      const t = await r.text();
      out.textContent = t;
      if (r.ok && textarea) textarea.value = '';
      carregarExames();
    } catch (e) {
      out.textContent = 'Erro ao salvar resultado: ' + e.message;
    }
  }

  async function uploadExameCard(nomeExame, refs = {}) {
    if (!prontuarioSelecionado) { out.textContent = 'Selecione um prontu√°rio.'; return; }
    const fileInput = refs.fileId ? document.getElementById(refs.fileId) : null;
    if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
      out.textContent = 'Escolha um arquivo.';
      return;
    }

    const data = refs.dataId ? (document.getElementById(refs.dataId)?.value || '') : '';
    const obs = refs.obsId ? (document.getElementById(refs.obsId)?.value || '') : '';
    const tipoFinal = (nomeExame || '').trim() || EXAME_SEM_IDENTIFICACAO;

    try {
      const fd = new FormData();
      fd.append('prontuario_id', prontuarioSelecionado);
      fd.append('tipo', tipoFinal);
      fd.append('observacoes', obs);
      fd.append('data_anexo', data);
      fd.append('arquivo', fileInput.files[0]);

      const r = await fetch('/exames/upload', { method:'POST', body: fd });
      const t = await r.text();
      out.textContent = t;
      if (r.ok) fileInput.value = '';
      carregarExames();
    } catch (e) {
      out.textContent = 'Erro no upload: ' + e.message;
    }
  }

  // --------------- previews
  function syncPreviews(){ previewSint.value = sintomas.value; previewAnam.value = anamnese.value; }
  sintomas.addEventListener('input', syncPreviews);
  anamnese.addEventListener('input', () => { syncPreviews(); atualizarDisponibilidadeIA(); });

  // --------------- badge gravidade
  function setBadge(gravidade) {
    gravBadge.className = 'badge';
    if (!gravidade) { gravBadge.textContent = ''; return; }
    const g = String(gravidade).toLowerCase();
    if (g.includes('alta')) { gravBadge.classList.add('grav-alta'); gravBadge.textContent = 'gravidade: alta'; }
    else if (g.includes('moder')) { gravBadge.classList.add('grav-moderada'); gravBadge.textContent = 'gravidade: moderada'; }
    else if (g.includes('baixa')) { gravBadge.classList.add('grav-baixa'); gravBadge.textContent = 'gravidade: baixa'; }
    else { gravBadge.textContent = ''; }
  }

  // --------------- format diagn√≥stico
  function formatSugestaoCompleta(sug) {
    if (!sug) return '(sem sugest√£o)';
    if (typeof sug === 'string') return sug;
    if (sug && typeof sug.texto === 'string') return sug.texto;

    const hip = Array.isArray(sug.hipoteses) ? sug.hipoteses : [];
    const grav = sug.gravidade || 'indefinida';
    const alarmes = Array.isArray(sug.sinais_alarme) ? sug.sinais_alarme : [];
    const jus = (sug.justificativa || '').trim();
    const rec = (sug.recomendacao || '').trim();
    const exames = Array.isArray(sug.exames_sugeridos) ? sug.exames_sugeridos : [];
    const conf = typeof sug.confianca === 'number' ? sug.confianca : undefined;

    let linhas = [];
    if (hip.length) linhas.push(`Hip√≥teses: ${hip.join('; ')}`);
    linhas.push(`Gravidade: ${grav}`);
    if (alarmes.length) linhas.push(`Sinais de alarme: ${alarmes.join('; ')}`);
    if (jus) linhas.push(`Justificativa: ${jus}`);
    if (rec) linhas.push(`Recomenda√ß√£o: ${rec}`);
    if (exames.length) linhas.push(`Exames sugeridos: ${exames.join('; ')}`);
    if (conf !== undefined) linhas.push(`Confian√ßa: ${conf.toFixed(2)}`);
    return linhas.join('\n');
  }

  // --------------- IA
  btnIa.addEventListener('click', async () => {
    btnIa.disabled = true;
    btnIa.textContent = 'Consultando IA...';
    try {
      const payload = {
        sintomas: sintomas.value || '',
        anamnese: anamnese.value || ''
      };
      if (prontuarioSelecionado) payload.prontuario_id = prontuarioSelecionado;

      const r = await fetch('/ai-diagnostico', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });

      const text = await r.text();
      let data;
      try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }

      if (!r.ok) {
        const msg = data.detail || data.error || `${r.status} ${r.statusText}` || 'Falha ao consultar IA';
        out.textContent = `Erro na IA: ${msg}`;
        return;
      }

      const sug = data.sugestao;
      diag.value = formatSugestaoCompleta(sug);
      setBadge(sug?.gravidade);
      out.textContent = JSON.stringify(sug, null, 2);
    } catch (e) {
      out.textContent = 'Erro na IA: ' + e.message;
    } finally {
      btnIa.textContent = 'ü™Ñ Sugerir diagn√≥stico (IA)';
      atualizarDisponibilidadeIA();
    }
  });

  // --------------- CRUD prontu√°rio
  function validaCampos() {
    if (!nome.value.trim() || !cpf.value.trim() || !dataC.value.trim()) {
      out.textContent = 'Preencha Nome, CPF e Data.'; return false;
    }
    return true;
  }

  async function salvar() {
    try {
      if (!validaCampos()) return;

      // IMPORTANTE: backend exige "diagnostico" -> usamos "Em avalia√ß√£o" se vazio
      const diagnosticoFinal = (diag.value || '').trim() || 'Em avalia√ß√£o';

      const body = {
        nome: nome.value,
        cpf: cpf.value,
        data_consulta: dataC.value,
        diagnostico: diagnosticoFinal,
        sintomas: sintomas.value || '',
        anamnese: anamnese.value || '',
        exames_solicitados: examesSolicitados
      };

      const isUpdate = Boolean(prontuarioSelecionado);
      const url = isUpdate ? `/prontuario/${prontuarioSelecionado}` : '/prontuario';
      const method = isUpdate ? 'PUT' : 'POST';

      const r = await fetch(url, {
        method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      });
      const txt = await r.text();
      out.textContent = txt;
      listar();
      try {
        const j = JSON.parse(txt);
        if (j.id) selecionarProntuario(j.id, body.nome, { atualizarForm: false });
      } catch {}
    } catch (e) { out.textContent = 'Erro ao salvar: ' + e.message; }
  }

  async function listar() {
    try {
      const r = await fetch('/prontuarios');
      const arr = await r.json();
      prontuariosCache = Array.isArray(arr) ? arr : [];
      if (!Array.isArray(arr) || arr.length === 0) { lista.innerHTML = '‚Äî sem dados ‚Äî'; return; }
      const rows = arr.map(p => `
        <tr>
          <td>${p.id}</td>
          <td><strong>${escapeHtml(p.nome)}</strong><br><span class="muted">${escapeHtml(p.cpf)}</span></td>
          <td>${escapeHtml(p.data_consulta)}</td>
          <td><pre style="white-space:pre-wrap;max-width:420px">${escapeHtml(p.diagnostico || '')}</pre></td>
          <td>
            <div class="muted">${(p.exames_solicitados||[]).map(escapeHtml).join(', ')}</div>
            <button onclick="selecionarProntuario(${p.id})">Selecionar</button>
          </td>
        </tr>`).join('');
      lista.innerHTML = `
        <table>
          <thead><tr><th>ID</th><th>Paciente</th><th>Data</th><th>Diagn√≥stico</th><th>A√ß√µes</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;

      if (prontuarioSelecionado) {
        const atual = prontuariosCache.find(p => Number(p.id) === Number(prontuarioSelecionado));
        if (atual) {
          preencherFormulario(atual);
          atualizarEstadoSelecao();
        }
      }
    } catch (e) { lista.innerHTML = 'Erro ao listar: ' + escapeHtml(e.message); }
  }

  function preencherFormulario(prontuario) {
    if (!prontuario) return;
    nome.value = prontuario.nome || '';
    cpf.value = prontuario.cpf || '';
    dataC.value = prontuario.data_consulta || '';
    sintomas.value = prontuario.sintomas || '';
    anamnese.value = prontuario.anamnese || '';
    diag.value = prontuario.diagnostico || '';
    examesSolicitados = Array.isArray(prontuario.exames_solicitados)
      ? [...prontuario.exames_solicitados]
      : [];
    renderChips();
    syncPreviews();
  }

  function selecionarProntuario(id, _nomePaciente='', opts = {}) {
    prontuarioSelecionado = Number(id);
    const atual = prontuariosCache.find(p => Number(p.id) === prontuarioSelecionado);
    pacienteSelecionadoNome = (atual && atual.nome) || _nomePaciente || pacienteSelecionadoNome;
    selId.textContent = String(prontuarioSelecionado);
    exmId.textContent = String(prontuarioSelecionado);
    exmNome.textContent = pacienteSelecionadoNome || '‚Äî';
    if (opts.atualizarForm !== false) preencherFormulario(atual);
    syncPreviews();
    carregarExames();
    atualizarEstadoSelecao();
    setTimeout(atualizarDisponibilidadeIA, 300);
  }

  function limpar() {
    nome.value = '';
    cpf.value = '';
    dataC.value = '';
    sintomas.value = '';
    anamnese.value = '';
    diag.value = '';
    prontuarioSelecionado = null;
    pacienteSelecionadoNome = null;
    examesSolicitados = [];
    examesPorTipo = {};
    renderChips();
    renderExamCards();
    setBadge('');
    syncPreviews();
    out.textContent = 'Formul√°rio limpo.';
    selId.textContent = '‚Äî';
    exmId.textContent = '‚Äî';
    exmNome.textContent = '‚Äî';
    examesLista.textContent = '‚Äî selecione um prontu√°rio ‚Äî';
    atualizarEstadoSelecao();
    atualizarDisponibilidadeIA();
  }

  async function excluir() {
    if (!prontuarioSelecionado) { out.textContent = 'Selecione um prontu√°rio.'; return; }
    if (!confirm('Tem certeza que deseja excluir este prontu√°rio? Esta a√ß√£o √© irrevers√≠vel.')) return;
    try {
      const r = await fetch(`/prontuario/${prontuarioSelecionado}`, { method: 'DELETE' });
      const txt = await r.text();
      out.textContent = txt;
      limpar();
      listar();
    } catch (e) { out.textContent = 'Erro ao excluir: ' + e.message; }
  }

  // --------------- Exames
  async function carregarExames() {
    hasExamResults = false;
    examesPorTipo = {};

    if (!prontuarioSelecionado) {
      examesLista.textContent = '‚Äî selecione um prontu√°rio ‚Äî';
      renderExamCards();
      atualizarDisponibilidadeIA();
      return;
    }

    try {
      const r = await fetch(`/exames?prontuario_id=${prontuarioSelecionado}`);
      const arr = await r.json();

      if (Array.isArray(arr)) {
        arr.forEach((e) => {
          const nomeChave = (typeof e.tipo === 'string' && e.tipo.trim()) ? e.tipo.trim() : EXAME_SEM_IDENTIFICACAO;
          const normalizado = {
            ...e,
            data_anexo: e.data_anexo || e.data_resultado || ''
          };
          if (!examesPorTipo[nomeChave]) examesPorTipo[nomeChave] = [];
          examesPorTipo[nomeChave].push(normalizado);
        });
        hasExamResults = arr.some((e) => {
          const temArquivo = typeof e.arquivo_path === 'string' && e.arquivo_path.trim() !== '';
          const temTexto = typeof e.resultado_texto === 'string' && e.resultado_texto.trim() !== '';
          return temArquivo || temTexto;
        });
      }

      if (!Array.isArray(arr) || arr.length === 0) {
        examesLista.textContent = 'Nenhum resultado registrado ainda.';
      } else {
        examesLista.textContent = 'Resultados exibidos nos cart√µes acima.';
      }

      renderExamCards();
      atualizarDisponibilidadeIA();
    } catch (e) {
      examesLista.textContent = 'Erro ao carregar exames: ' + e.message;
      examesPorTipo = {};
      renderExamCards();
      atualizarDisponibilidadeIA();
    }
  }

  // --------------- Gating IA
  function atualizarDisponibilidadeIA() {
    const anamnesePreenchida = anamnese.value.trim().length > 20;
    const podeUsarIA = anamnesePreenchida && hasExamResults;

    btnIa.disabled = !podeUsarIA;
    diag.disabled = !podeUsarIA;

    if (!podeUsarIA) {
      gatingHint.textContent = 'Preencha anamnese e adicione ao menos um exame com resultado (arquivo ou texto).';
      diag.placeholder = 'Aguardando anamnese e exames para liberar o diagn√≥stico...';
    } else {
      gatingHint.textContent = '';
      diag.placeholder = 'Ser√° preenchido pela IA ou manualmente.';
    }
  }
  const examesObserver = new MutationObserver(atualizarDisponibilidadeIA);
  if (examesCards) examesObserver.observe(examesCards, { childList: true, subtree: true });

  // --------------- utils
  function escapeHtml(s='') {
    return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
                    .replaceAll('"','&quot;').replaceAll("'","&#039;");
  }
  function escapeAttr(s='') { return String(s).replaceAll('\\','\\\\').replaceAll("'", "\\'"); }

  // boot
  renderChips();
  listar();
  syncPreviews();
  atualizarDisponibilidadeIA();
  atualizarEstadoSelecao();
</script>
</body>
</html>
